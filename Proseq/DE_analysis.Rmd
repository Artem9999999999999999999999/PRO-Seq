---
title: "DE_analysis_proseq"
author: "ManasyanAL"
date: "14 08 2023"
output: html_document
---

```{r}
library(DESeq2)
library(ggplot2)
library(RColorBrewer)
library(pheatmap)
library(EnhancedVolcano)
```

## Loading dataset

```{r}
Counts <- read.delim("data/result_featurecounts.csv", header = TRUE, row.names = 1, sep = ",")
```

## Remove genes with null expression

```{r}
Counts <- Counts[which(rowSums(Counts) > 10),]
```

```{r}
head(Counts, 10)
```

```{r}
dim(Counts)
```

## Creating DESeqDataSet Objects

```{r}
# Создание вектора с метками условий
condition <- c("Ctrl", "Auxin", "Ctrl", "Auxin", "Ctrl", "Auxin", "Ctrl", "Auxin")

# Создание вектора с метками типов
type <- rep(c("S2", "Chd1"), each = 4)

# Создание объекта DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = Counts,
                              colData = DataFrame(condition = factor(condition), type = factor(type)),
                              design = ~condition+type)

```

## DE analysis
```{r}
dds <- DESeq(dds)
```

```{r}
rld <- rlog(dds)

# Построение графика PCA с разделением по condition и type
pca_data <- plotPCA(rld, intgroup = c("condition", "type"), returnData = TRUE)

# Создание графика с ggplot2
ggplot(pca_data, aes(x = PC1, y = PC2, color = condition, shape = type)) +
  geom_point(size = 4) +
  xlab(paste0("PC1: ", round(100 * pca_data$percentVar[1], 1), "% variance")) +
  ylab(paste0("PC2: ", round(100 * pca_data$percentVar[2], 1), "% variance")) +
  ggtitle("PCA Plot") +
  theme_minimal()
```
## Test contrasts and get results
```{r}
dds_s2 <- dds[dds$type == "S2", ]
dds_chd1 <- dds[dds$type == "Chd1", ]
dds_auxin <- dds[dds$condition == "Auxin", ]

# Сравнение Ctrl vs Auxin для S2
dds_s2_contrast <- DESeq(dds_s2)
res_s2_auxin_vs_ctrl <- results(dds_s2_contrast, contrast = c("condition","Auxin", "Ctrl"))

# Сравнение Ctrl vs Auxin для Chd1
dds_chd1_contrast <- DESeq(dds_chd1)
res_chd1_auxin_vs_ctrl <- results(dds_chd1_contrast, contrast = c("condition","Auxin", "Ctrl"))

# Сравнение Auxin S2 vs Auxin Chd1
dds_auxin_contrast <- DESeq(dds_auxin)
res_s2_vs_chd1_auxin <- results(dds_auxin_contrast, contrast = c("type", "S2", "Chd1"))
```


```{r}
summary(res_s2_auxin_vs_ctrl, alpha = 0.01)
summary(res_chd1_auxin_vs_ctrl, alpha = 0.01)
summary(res_s2_vs_chd1_auxin, alpha = 0.01)
```

## Filter results by adjusting for pudge value and log2foldchange

```{r}
padj.cutoff <- 0.01
lfc.cutoff <- 0.58
```

```{r}
sig_res_s2 <- res_s2_auxin_vs_ctrl[which(res_s2_auxin_vs_ctrl$padj < padj.cutoff & abs(res_s2_auxin_vs_ctrl$log2FoldChange) > lfc.cutoff), ]
sig_res_chd1 <- res_chd1_auxin_vs_ctrl[which(res_chd1_auxin_vs_ctrl$padj < padj.cutoff & abs(res_chd1_auxin_vs_ctrl$log2FoldChange) > lfc.cutoff), ]
sig_res_auxin <- res_s2_vs_chd1_auxin[which(res_s2_vs_chd1_auxin$padj < padj.cutoff & abs(res_s2_vs_chd1_auxin$log2FoldChange) > lfc.cutoff), ]
```

```{r}
summary(sig_res_s2)
summary(sig_res_chd1)
summary(sig_res_auxin)
```

## Create graphs

### MAplot

```{r}
s2_resLFC <- lfcShrink(dds_s2, coef = "condition_Ctrl_vs_Auxin", type = "apeglm",
                    lfcThreshold = 1)
chd1_resLFC <- lfcShrink(dds_chd1, coef = "condition_Ctrl_vs_Auxin", type = "apeglm",
                    lfcThreshold = 1)
auxin_resLFC <- lfcShrink(dds_auxin, coef = "type_S2_vs_Chd1", type = "apeglm",
                    lfcThreshold = 1)
```


```{r}
plotMA(s2_resLFC, ylim = c(-5, 5), main = "MA Plot for S2")
plotMA(chd1_resLFC, ylim = c(-3, 3), main = "MA Plot for Chd1")
plotMA(auxin_resLFC, ylim = c(-10, 10), main = "MA Plot for S2 vs Chd1")
```
### Table output with a difference in DE

```{r}
diff_expr_s2 <- data.frame(row.names = rownames(sig_res_s2), log2FoldChange = sig_res_s2$log2FoldChange, padj = sig_res_s2$padj)
diff_expr_chd1 <- data.frame(row.names = rownames(sig_res_chd1), log2FoldChange = sig_res_chd1$log2FoldChange, padj = sig_res_chd1$padj)
diff_expr_auxin <- data.frame(row.names = rownames(sig_res_auxin), log2FoldChange = sig_res_auxin$log2FoldChange, padj = sig_res_auxin$padj)
```

```{r}
diff_expr_s2
diff_expr_chd1
diff_expr_auxin
```

```{r}
summary_table <- data.frame(
  Condition = c("S2", "Chd1", "Auxin"),
  Up = c(sum(sig_res_s2$log2FoldChange > lfc.cutoff), sum(sig_res_chd1$log2FoldChange > lfc.cutoff), sum(sig_res_auxin$log2FoldChange > lfc.cutoff)),
  Down = c(sum(sig_res_s2$log2FoldChange < -lfc.cutoff), sum(sig_res_chd1$log2FoldChange < -lfc.cutoff), sum(sig_res_auxin$log2FoldChange < -lfc.cutoff))
)
```


```{r}
summary_table
```

```{r}
results_folder <- "results"
file_path <- file.path(results_folder, "summary_table.csv")

write.csv(summary_table, file_path, row.names = FALSE)

cat("Таблица сохранена в файле:", file_path, "\n")
```

```{r}
figures_folder <- "figures"

if (!file.exists(figures_folder)) {
  dir.create(figures_folder)
}

plot_path_s2 <- file.path(figures_folder, "MA_Plot_S2.png")
plot_path_chd1 <- file.path(figures_folder, "MA_Plot_Chd1.png")
plot_path_auxin <- file.path(figures_folder, "MA_Plot_Auxin.png")

png(plot_path_s2)
plotMA(s2_resLFC, ylim = c(-5, 5), main = "MA Plot for S2")
dev.off()

png(plot_path_chd1)
plotMA(chd1_resLFC, ylim = c(-3, 3), main = "MA Plot for Chd1")
dev.off()

png(plot_path_auxin)
plotMA(auxin_resLFC, ylim = c(-10, 10), main = "MA Plot for S2 vs Chd1")
dev.off()

cat("Графики сохранены в папке:", figures_folder, "\n")
```












